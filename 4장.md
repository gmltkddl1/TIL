> 해당 글은 [가상 면접 사례로 배우는 대규모 시스템 설계 기초] (https://product.kyobobook.co.kr/detail/S000001033116) 4장을 정리한 글입니다.

# 처리율 제한 장치
처리율 제한 장치 (rate limiter)는 클라이언트가 보내는 트래픽의 처리율을 제어하기 위한 장치다.
예를들면 특정 시간 내의 클라이언트의 요청 횟수를 제한한다. 해당 횟수를 넘어선 요청은 처리가 중단된다. (버리거나, 큐에 넣거나)

## 처리율 제한 장치의 장점
- Dos 공격을 방지 할수 있다.
- 비용이 절감된다. (쓸데 없는 요청을 처리하지 않으므로 특히 3rd 파티 요청에 과금이 있을 경우)
- 서버 부하가 줄어든다

## 처리율 제한 장치 설계
- 위치는 클라이언트보다는 서버가 좋다. 이유는 클라이언트 데이터는 쉽게 위변조가 가능하기 때문이다.
- API 서버 내에 둘수도 있고 별도의 미들웨어로 만들수도 있다.
- API Gateway에 많이들 구현한다.

## 처리율 제한 알고리즘
1. 토큰 버킷
- 특정 저장 공간에 토큰을 정해진 양 채워 넣고 정해진 시간마다 다시 채운다. 토큰이 남아있을때만 요청을 허용한다
- 장점: 메모지 효율이 좋고 간단하며 순간적인 다량 트래픽의 처리가 가능하다
- 단점: 버킷 사이즈와 토큰 공급율의 파라미터 튜닝이 어렵다.
2. 누출 버킷
- 정해진 크기와 정해진 처리량의 메세지 큐를 두고 해당 메세지 큐에 공간이 남아 있을때만 요청을 허용한다.
3. 고정 윈도우 카운터
4. 이동 윈도우 로그
5. 이동 윈도우 카운터

## 아키텍쳐
- 기본적으로 추적대상에 대한 카운터를 만들고 그 카운터가 한도를 넘으면 요청을 거부한다.
- DB는 디스크 접근이 응답속도에 영향을 주기 때문에 적절하지 않고 속도가 빠른 메모리 기반 캐시(Redis)가 빠른속도와 시간에 따른 만료 기능을 제공하므로 적절하다.
- 처리 한도는 미들웨어나 인터셉터 등을 활용하여 정책을 만든다.
- 처리 한도 초과된 요청은 버리거나 추후 처리를 위해 큐에 보관할 수 있다.
- 처리 제한 장치는 HTTP 응답으로 X-Ratelimit-Remaining, X-Ratelimit-Limit, X-Ratelimit-Retry-After 등의 헤더를 사용하여 클라이언트에게 처리제한 정보를 전달한다.

## 분산 환경에서의 처리
분산 환경에서는 경쟁조건(Race condition)과 동기화(synchronization)을 고려해야한다.
경쟁 조건 해결방법
- 락
  - 성능 저하가 심하다.
- ***루아 스크립트, 정렬 집합 활용 가능****
동기화 해결법
- 고정 세션(sticky session)
  - 확장이 어려워 비추천
- 레디스 같은 중앙 저장소 활용이 좋다

데이터 동기화 시에는 최종 일관성 모델을 사용하자

## 모니터링
처리율 제한 장치가 효과적으로 동작하는지 확인하기 위해서 모니터링이 필요하다.
처리율 제한 알고리즘과 처리율 제한 규칙이 효율적인지 확인하며 튜닝이 필요하다.


## 기타
경성(hard) 연성(soft) 처리율 제한
- 경성: 요청 개수는 절대 임계치를 넘을수 없다
- 연성: 순간적으로는 넘을 수 있다.
다른 계층에서의 처리율 제한
클라이언트에서의 처리율 제한
- API 캐싱
- 시간당 요청 제한
- Gracefully recover
  
