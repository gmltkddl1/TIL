# 분산 키 밸류 저장소
## 요구사항
- 이 장에서 구현하려는 분산 키 밸류 저장소는 다음 조건을 만족하는 저장소이다
1.  키 밸류 쌍의 크기가 10KB 이하
2.  많은 데이터 저장 가능
3.  높은 가용성 즉 장애가 발생해도 빠른 속도로 응답이 가능해야함
4.  높은 확장성 트래픽의 양에 따라 자동으로 서버가 늘었다 줄었다 할수 있어야 한다.
5.  데이터 일관성 수준은 조정이 가능해야한다.
6.  응답 지연시간은 짧아야한다

## 단일 키 값 저장소
- 단일 서버에서는 빠른 속도로 응답이 가능하지만 충분히 많은 양의 데이터가 들어오면 메모리에 한계가 있으므로 데이터가 많아지면 문제가 생긴다.
- 데이터를 압축하거나 사용하는 데이터만 메모리에 올리고 나머지를 디스크에 저장하는 방법으로 좀 더 많은 데이터를 지원할수있지만 한계가 있다.

## 분산 키 값 저장소
### CAP 정리
- **분산환경에서 가용성, 일관성, 파티션 감내성 이 세가지를 동시에 달성하는 것은 불가능하다.**
- 가용성: 분산 시스템 중 일부 서버의 장애가 발생하더라도 응답이 가능해야한다.
- 일관성: 분산 시스템 중 어떤 서버에 요청하더라도 동일한 데이터를 받아야한다.
- 파티션 감내: 분산 시스템 일부 노드 사이의 네트워크 장애가 발생하여도 전체 시스템은 정상 동작해야한다.
- 네트워크 장애는 분산 시스템에서 피할 수 없으므로 분산 시스템은 CP와 AP만 존재한다. 즉 네트워크 장애에도 동작하는 시스템을 만드려면 장애시의 가용성과 일관성 중 선택을해야한다.

### 분산 키 값 저장소의 구성요소
- 데이터 파티션: 안정 해쉬 알고리즘을 이용해서 일부 서버 장애시에도 키 재배치 양을 줄일 수 있다.
- 데이터 다중화: 안정 해쉬에서 처음 만난 서버뿐 아니라 N번째 만난 서버까지 저장하는 방식으로 다중화를 할 수 있다.
- 데이터 일관성: 정족수 프로토콜 N=다중화서버수, W=쓰기가 성공했다고 처리하는데 최소 서버 성공 응답 수, R=읽기가 성공한것으로 처리하기 위한 최소 서버 성공 응답 수
  - 강한 일관성: 모든 서버는 읽기 연산에 대해 반드시 최신 데이터를 반환한다. 모든 사본에 쓰기가 반영될때까지 읽기 쓰기를 금지한다.
  - 약한 일관성: 모든 서버는 읽기 연산에 대해 최신 데이터를 반환하지 못할수도 있다.
  - 결과적 일관성: 약관 일관성 모델 중 하나 결국 최신 결과가 모든 서버에 반영된다. (가용성 높음) 
- 일관성 불일치 해소: 버저닝과 벡터 시계로 충돌을 감지한다.
- 장애 감지: 가쉽 프로토콜은 각 서버가 주기적으로 자신의 하트비트를 증가시키고 무작위 서버로 선택한 서버에게 전체 서버의 하트비트 목록을 전파하는 방식
- 일시적 장애 처리: 엄격한 정족수는 특정 키는 반드시 지정된 서버에 읽고 쓴다, 느슨한 정족수(hinted handoff)는 특정 서버가 응답이 없으면 임시서버에 (A,B,C가 원래 서버일 때 D)에 쓰고 해당 서버에 저장될 데이터라는 표시를 남기고 추후에 동기화
- 영구적 장애 처리: 반 엔트로피 프로토콜 사용하여 동기화 비교시에는 머클 트리 사용

###
- 분산된 서버에 데이터를 분배하는 일은 안정해시 알고리즘을 사용하여 분배하는 것이 좋다 이유는 서버를 추가하거나 제거할때 키의 재배치가 많이 일어나지 않기 때문
- 
